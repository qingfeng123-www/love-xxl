<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å¿ƒæ¶ˆæ¶ˆä¹ - ç»ˆæä¿®å¤ç‰ˆ</title>
    <style>
        /* å†…è”æ ·å¼ç¡®ä¿ä¸ä¾èµ–å¤–éƒ¨CSSæ–‡ä»¶ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: url('image.jpg') center center / cover no-repeat fixed;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .screen {
            position: relative;
            width: 100%;
            max-width: 980px;
            margin: 0 auto;
            padding: 20px;
            border-radius: 20px;
            /* ç§»é™¤èƒŒæ™¯å›¾ç‰‡ï¼Œä»…ä¿ç•™æ¨¡ç³Šå’Œé˜´å½± */
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .screen.hidden {
            display: none;
        }

        .game-title {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            margin-bottom: 30px;
            text-align: center;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 10px;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            box-shadow: 0 8px 20px rgba(78, 205, 196, 0.4);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(78, 205, 196, 0.6);
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 300px;
            margin: 0 auto;
            text-align: center;
        }

        .game-screen {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            min-height: 960px;
        }

        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            height: 960px;
        }

        .game-canvas {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            background: #fff;
            border: 3px solid #fff;
            width: 640px;
            height: 960px;
        }

        .game-info {
            min-width: 250px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            height: 960px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section:last-child {
            margin-bottom: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .info-section h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 8px;
        }

        .stat-value {
            font-weight: bold;
            color: #007bff;
            font-size: 1.1em;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.5);
        }

        .level-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 15px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            color: #495057;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .level-btn:hover {
            transform: scale(1.1);
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }

        .level-btn.completed {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .level-btn.completed:hover {
            background: linear-gradient(45deg, #1e7e34, #17a2b8);
            transform: scale(1.1);
        }

        .level-btn.completed::after {
            content: 'âœ“';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.8em;
            color: #fff;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 10000;
            text-align: center;
            font-size: 18px;
            max-width: 400px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.5em;
            color: #666;
        }

        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
            max-width: 300px;
        }

        /* æµ®åŠ¨æç¤ºä¸å±‚ */
        .tip-layer{position:absolute;left:0;top:0;width:640px;height:960px;pointer-events:none;}
        .floating-tip{position:absolute;font-weight:bold;font-size:20px;color:#fff;text-shadow:0 0 8px #000, 0 0 12px #000;opacity:0;animation:tipFloat 1.5s ease-out forwards;z-index:100;}
        @keyframes tipFloat{0%{transform:translate(-50%,0) scale(0.8);opacity:0;}15%{opacity:1;transform:translate(-50%,0) scale(1.2);}80%{opacity:1;transform:translate(-50%,-40px) scale(1.1);}100%{transform:translate(-50%,-80px) scale(1.3);opacity:0;}}

        /* éŸ³é¢‘è§£é”æŒ‰é’®åŠ¨ç”» */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px #2196F3; }
            50% { box-shadow: 0 0 20px #2196F3, 0 0 30px #2196F3; }
        }

        .tool-bar{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;justify-content:center;}
        /* æ–°çš„ç«–ç›´æ’åˆ—æŒ‰é’®ç»„æ ·å¼ */
        .control-buttons {
            display: flex;
            flex-direction: column;
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            flex: 1;
        }
        
        .control-btn-group {
            width: 100%;
            height: 100%; /* ç¡®ä¿å æ®æ‰€æœ‰å¯ç”¨ç©ºé—´ */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* æŒ‰é’®é—´å‡åŒ€åˆ†å¸ƒ */
            align-items: center;
            padding: 0;
            gap: 15px; /* æŒ‰é’®é—´çš„é—´è· */
        }
        
        .control-buttons .btn {
            width: 100%;
            max-width: 240px;
            min-height: 44px;
            font-size: 1.18rem;
            border-radius: 28px;
            border: none;
            background: linear-gradient(90deg, #ff7e7e 0%, #6ee7b7 100%);
            color: #fff;
            box-shadow: 0 3px 12px rgba(0,0,0,0.09);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto; /* ç§»é™¤å‚ç›´æ–¹å‘çš„å¤–è¾¹è· */
            transition: background 0.3s, color 0.3s, opacity 0.3s;
            user-select: none;
        }
        
        .control-buttons .btn.orange-toggle {
            background: linear-gradient(90deg, #ff9800 0%, #ff7e7e 100%) !important;
            color: #fff3e0 !important;
            box-shadow: 0 2px 12px rgba(255,152,0,0.18) !important;
        }

        @media (max-width: 768px) {
            .game-screen {
                flex-direction: column;
            }
            .game-info {
                min-width: unset;
                width: 100%;
                order: -1;
            }
            .level-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }
            .control-buttons {
                width: 100%;
                height: auto;
            }
            .control-btn-group {
                gap: 12px;
            }
            .control-buttons .btn {
                width: 100%;
                min-width: 120px;
                min-height: 38px;
            }
        }
    </style>
</head>
<body>
    <div id="debugInfo" class="debug-info">æ­£åœ¨åŠ è½½æ¸¸æˆ...</div>

    <div class="container">
        <!-- ä¸»èœå•ç•Œé¢ -->
        <div id="mainMenu" class="screen">
            <h1 class="game-title">ğŸ® å¼€å¿ƒæ¶ˆæ¶ˆä¹</h1>
            <p style="text-align: center; font-size: 1.2em; color: #666; margin-bottom: 30px;">
                ç»å…¸ä¸‰æ¶ˆæ¸¸æˆï¼Œ100ä¸ªå…³å¡ç­‰ä½ æŒ‘æˆ˜ï¼
            </p>
            <div class="menu-buttons">
                <button id="startGameBtn" class="btn btn-primary">
                    ğŸš€ å¼€å§‹æ¸¸æˆ
                </button>
                <button id="levelSelectBtn" class="btn btn-secondary">
                    ğŸ¯ é€‰æ‹©å…³å¡
                </button>
                <button id="freePlayBtn" class="btn btn-secondary">
                    â™¾ï¸ è‡ªç”±æ¨¡å¼
                </button>
            </div>
        </div>

        <!-- å…³å¡é€‰æ‹©ç•Œé¢ -->
        <div id="levelSelect" class="screen hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸ¯ é€‰æ‹©å…³å¡</h2>
            <div id="levelGrid" class="level-grid"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="backToMenuBtn" class="btn btn-secondary">
                    ğŸ  è¿”å›ä¸»èœå•
                </button>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div id="gameScreen" class="screen game-screen hidden">
            <!-- æ¸¸æˆä¿¡æ¯é¢æ¿ -->
            <div class="game-info">
                <div class="info-section">
                    <h3>ğŸ“Š æ¸¸æˆçŠ¶æ€</h3>
                    <div class="stat-item">
                        <span>å…³å¡</span>
                        <span id="currentLevel" class="stat-value">1</span>
                    </div>
                    <div class="stat-item">
                        <span>åˆ†æ•°</span>
                        <span id="score" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span>å‰©ä½™æ­¥æ•°</span>
                        <span id="moves" class="stat-value">30</span>
                    </div>
                    <div class="stat-item">
                        <span>è¿é”</span>
                        <span id="chainInfo" class="stat-value">-</span>
                    </div>
                </div>

                <div class="info-section">
                    <h3>ğŸ¯ ç›®æ ‡</h3>
                    <div id="objective">è¾¾åˆ° 2000 åˆ†</div>
                </div>

                <div class="info-section" style="flex: 1; display: flex; flex-direction: column; padding: 0;">
                    <h3 style="margin-bottom: 16px;">ğŸ® æ§åˆ¶</h3>
                    <div class="control-buttons">
                        <div class="control-btn-group">
                            <button id="restartBtn" class="btn btn-primary">ğŸ”„ é‡å¯</button>
                            <button id="backToLevelSelectBtn" class="btn btn-secondary">ğŸ  è¿”å›</button>
                            <button id="muteBtn" class="btn btn-secondary">ğŸ”Š é™éŸ³</button>
                            <button id="toolShuffle" class="btn btn-secondary">ğŸŒ€ æ´—ç‰Œ</button>
                            <button id="toolColorBomb" class="btn btn-secondary">ğŸŒˆ å˜å½©è™¹</button>
                            <button id="addMovesBtn" class="btn btn-secondary add-step-btn">â• åŠ æ­¥æ•°</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆåŒºåŸŸ -->
            <div class="game-area">
                <canvas id="gameCanvas" class="game-canvas" width="640" height="960"></canvas>
                <div id="tipLayer" class="tip-layer"></div>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´ : ç§»é™¤loopå±æ€§ï¼Œæ”¹ä¸ºæ’­æ”¾åˆ—è¡¨é¡ºåºæ’­æ”¾ -->
    <audio id="bgMusic" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto" playsinline></audio>
    <audio id="popSound" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto" playsinline></audio>
    <audio id="comboSound" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto" playsinline></audio>
    <audio id="winSound" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto" playsinline></audio>
    <audio id="loseSound" src="data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAALGFuYwAAAA8AAAACAAACcQCA//////////////////////////////////////////8AAAAA" preload="auto" playsinline></audio>

    <script>
    // æŒ‰é’®ç‚¹å‡»é«˜äº®ï¼ˆå˜è‰²ï¼‰æ•ˆæœï¼Œå…¼å®¹ç§»åŠ¨ç«¯
    document.addEventListener('DOMContentLoaded', function() {
        // ä»…é™¤è¿”å›ã€é‡å¯ã€æ´—ç‰Œå¤–çš„æŒ‰é’®ç‚¹å‡»å˜æ©™è‰²
        var excludeIds = ['restartBtn', 'backToLevelSelectBtn', 'toolShuffle'];
        document.querySelectorAll('.control-buttons .btn').forEach(function(btn){
            if (excludeIds.includes(btn.id)) return;
            btn.addEventListener('click', function(e){
                document.querySelectorAll('.control-buttons .btn').forEach(function(otherBtn){
                    if(otherBtn !== btn && !excludeIds.includes(otherBtn.id)) {
                        otherBtn.classList.remove('orange-toggle');
                    }
                });
                btn.classList.toggle('orange-toggle');
            });
        });
    });
    // ================== åŸºç¡€å·¥å…·ä¸å…¨å±€ ==================
    let GameEngine = null;

    if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r){
            r=Math.min(r, w/2, h/2);this.beginPath();this.moveTo(x+r,y);this.lineTo(x+w-r,y);this.arcTo(x+w,y,x+w,y+r,r);this.lineTo(x+w,y+h-r);this.arcTo(x+w,y+h,x+w-r,y+h,r);this.lineTo(x+r,y+h);this.arcTo(x,y+h,x,y+h-r,r);this.lineTo(x,y+r);this.arcTo(x,y,x+r,y,r);this.closePath();
        };
    }
    function debugLog(msg){const d=document.getElementById('debugInfo'); if(d){d.innerHTML='['+new Date().toLocaleTimeString()+'] '+msg;} console.log('[GAME]',msg);} 
    function showError(message){ alert(message); }

    // ================== UI æ§åˆ¶ ==================
    const SimpleUI={currentScreen:'mainMenu',showScreen(name){['mainMenu','levelSelect','gameScreen'].forEach(id=>{const el=document.getElementById(id); if(el) el.classList.add('hidden');}); const t=document.getElementById(name); if(t){t.classList.remove('hidden'); this.currentScreen=name; if(name==='levelSelect') this.createLevelGrid(); if(name==='gameScreen') this.initGameScreen();}},createLevelGrid(){const grid=document.getElementById('levelGrid'); if(!grid) return; grid.innerHTML=''; for(let i=1;i<=100;i++){const btn=document.createElement('button'); btn.className='level-btn'; btn.textContent=i; btn.onclick=()=>this.startLevel(i); if(GameEngine){ const completed=GameEngine.getCompletedLevels(); if(completed[i]) btn.classList.add('completed'); } grid.appendChild(btn);} },startLevel(id){this.showScreen('gameScreen'); if(GameEngine) GameEngine.startLevel(id);},initGameScreen(){setTimeout(()=>{ if(GameEngine){ GameEngine.initCanvas(); GameEngine.render();}},80);}};

    // ================== æ¸¸æˆå¼•æ“ï¼ˆå•ä¸€æœ‰æ•ˆç‰ˆæœ¬ï¼‰ ==================
    class SimpleGameEngine {
        constructor(){
            // å°ºå¯¸ï¼š8åˆ—12è¡Œ
            this.gridCols=8; this.gridRows=12; // æ—§ä»£ç é‡Œä½¿ç”¨ gridSize çš„åœ°æ–¹éœ€è¦å…¼å®¹åˆ—æ•°ï¼Œå› æ­¤ï¼š
            this.gridSize=this.gridCols; 
            this.canvas=null; this.ctx=null; this.tileSize=80; // 640/8
            this.grid=[]; this.score=0; this.moves=0; this.baseMoves=20; this.levelId=1; this.targetScore=400; this.selectedGem=null; this.isPlaying=false; this.gemTypes=6;
            this.allColors=['#ff5722','#2196f3','#4caf50','#ffeb3b','#9c27b0','#ff9800','#00bcd4','#8bc34a','#e91e63'];
            this.gemColors=this.allColors.slice(0,this.gemTypes);
            this.animating=false; this.particles=[]; this.effects=[]; this.currentChain=0; this.currentTool=null; this.colorToolAvailable=true;
            this.unlockedLevels=this.loadUnlocked(); this.audio=this.initAudio(); this.isMuted=false; this.audioUnlocked=false; this.imageWarned=false; this.images=[];
            this.accentColors=['#ff6b6b','#4ecdc4','#45b7d1','#96ceb4','#ffa94d','#9775fa','#74c0fc','#63e6be','#f06595'];
            this.musicSources=[]; // äº”é¦–èƒŒæ™¯éŸ³ä¹åˆ—è¡¨
            this.currentMusicIndex=0;
            this.musicStarted=false;
            this.preloadImages();
            
            // åˆå§‹åŒ–å®Œæˆåç«‹å³å°è¯•å¯åŠ¨éŸ³é¢‘ï¼Œå¢åŠ å»¶è¿Ÿç¡®ä¿èµ„æºåŠ è½½å®Œæˆ
            setTimeout(() => {
                debugLog('å°è¯•å¯åŠ¨éŸ³é¢‘è§£é”...');
                this.ensureAudioUnlock();
            }, 500);
            
            setTimeout(() => {
                debugLog('å°è¯•å¯åŠ¨èƒŒæ™¯éŸ³ä¹æ’­æ”¾åˆ—è¡¨...');
                this.startMusicPlaylist();
            }, 1000);
        }
        // ---------- èµ„æº ----------
        preloadImages(){this.imagesLoadedCount=0; this.imagesFailedCount=0; this.totalImages=this.allColors.length; for(let i=0;i<this.totalImages;i++){const img=new Image(); img.onload=()=>{img.loaded=true; this.imagesLoadedCount++; this.checkImageLoadComplete();}; img.onerror=()=>{img.failed=true; this.imagesFailedCount++; this.checkImageLoadComplete();}; img.src='images/gem'+i+'.png?t='+(Date.now()); this.images[i]=img;} debugLog('åŠ è½½å®çŸ³å›¾ç‰‡ '+this.totalImages+' ä¸ª'); }
        checkImageLoadComplete(){ if(this.imagesLoadedCount+this.imagesFailedCount>=this.totalImages){ debugLog('å›¾ç‰‡åŠ è½½å®Œæˆ æˆåŠŸ:'+this.imagesLoadedCount+' å¤±è´¥:'+this.imagesFailedCount); if(this.imagesLoadedCount===0) debugLog('å…¨éƒ¨å¤±è´¥ï¼Œä½¿ç”¨é¢œè‰²æ›¿ä»£'); } }
        initAudio(){
            debugLog('å¼€å§‹åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ');
            const a={bg:document.getElementById('bgMusic'),pop:document.getElementById('popSound'),combo:document.getElementById('comboSound'),win:document.getElementById('winSound'),lose:document.getElementById('loseSound')};
            if(a.bg){a.bg.preload='auto'; a.bg.volume=0.85; a.bg.loop=false;} // loopæ”¹ç”±æ’­æ”¾åˆ—è¡¨æ§åˆ¶
            ['pop','combo','lose'].forEach(k=>{if(a[k]){a[k].preload='auto'; a[k].volume=0.7;}});
            if(a.win){a.win.preload='auto'; a.win.volume=0.3;}
            
            // åˆå§‹åŒ–éŸ³ä¹æºåˆ—è¡¨
            const basePath='audio/9439/';
            const candidates=['bg1.mp3','bg2.mp3','bg3.mp3','bg4.mp3','bg5.mp3'];
            this.musicSources=candidates.map(n=>basePath+n);
            debugLog('éŸ³ä¹æºåˆ—è¡¨å·²åˆå§‹åŒ–: ' + this.musicSources.join(', '));
            
            // ç«‹å³åŠ è½½æ‰€æœ‰éŸ³æ•ˆæ–‡ä»¶
            const soundMap={pop:'pop',combo:'combo',win:'win',lose:'lose'};
            Object.keys(soundMap).forEach(k=>{
                const el=a[k];
                if(el) {
                    el.src=basePath+soundMap[k]+'.mp3?t='+(Date.now());
                    el.load();
                    // ä¸ºéŸ³æ•ˆæ·»åŠ é”™è¯¯å¤„ç†
                    el.addEventListener('error', () => {
                        debugLog('éŸ³æ•ˆæ–‡ä»¶åŠ è½½å¤±è´¥: ' + k + 'ï¼Œä½¿ç”¨é»˜è®¤éŸ³æ•ˆ');
                    });
                }
            });
            
            // ç»‘å®šæ’­æ”¾ç»“æŸäº‹ä»¶ - å®ç°æ’­æ”¾åˆ—è¡¨å¾ªç¯
            if(a.bg){
                a.bg.addEventListener('ended', () => {
                    if(this.isMuted || !this.isPlaying) {
                        debugLog('éŸ³ä¹ç»“æŸï¼Œä½†æ¸¸æˆæœªåœ¨è¿è¡Œæˆ–å·²é™éŸ³');
                        return;
                    }
                    // éšæœºé€‰æ‹©ä¸‹ä¸€é¦–
                    this.currentMusicIndex = Math.floor(Math.random() * this.musicSources.length);
                    debugLog('éŸ³ä¹æ’­æ”¾å®Œæ¯•ï¼Œéšæœºåˆ‡æ¢åˆ°ç¬¬ ' + (this.currentMusicIndex + 1) + ' é¦–');
                    this.playNextMusic();
                });
                
                // ç›‘å¬åŠ è½½é”™è¯¯ï¼Œè‡ªåŠ¨è·³åˆ°ä¸‹ä¸€é¦–
                a.bg.addEventListener('error', () => {
                    debugLog('éŸ³ä¹åŠ è½½å¤±è´¥ï¼Œéšæœºè·³åˆ°ä¸‹ä¸€é¦–');
                    this.currentMusicIndex = Math.floor(Math.random() * this.musicSources.length);
                    this.playNextMusic();
                });
            }
            
            debugLog('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            return a;
        }
        // æ’­æ”¾ä¸‹ä¸€é¦–éŸ³ä¹çš„æ–¹æ³•
        playNextMusic() {
            if(!this.audio || !this.audio.bg || this.isMuted) {
                debugLog('æ’­æ”¾æ¡ä»¶ä¸æ»¡è¶³: audio=' + !!this.audio + ', bg=' + !!(this.audio && this.audio.bg) + ', muted=' + this.isMuted);
                return;
            }
            
            // ç¡®ä¿musicSourceså·²åˆå§‹åŒ–
            if(!this.musicSources || this.musicSources.length === 0) {
                debugLog('éŸ³ä¹æºåˆ—è¡¨ä¸ºç©ºï¼Œé‡æ–°åˆå§‹åŒ–');
                const basePath = 'audio/9439/';
                const candidates = ['bg1.mp3', 'bg2.mp3', 'bg3.mp3', 'bg4.mp3', 'bg5.mp3'];
                this.musicSources = candidates.map(n => basePath + n);
                this.currentMusicIndex = 0;
            }
            
            // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
            if(this.currentMusicIndex >= this.musicSources.length || this.currentMusicIndex < 0) {
                this.currentMusicIndex = Math.floor(Math.random() * this.musicSources.length);
            }
            
            const bg = this.audio.bg;
            const currentSrc = this.musicSources[this.currentMusicIndex];
            
            if(!currentSrc) {
                debugLog('å½“å‰éŸ³ä¹æºä¸ºç©ºï¼Œç´¢å¼•: ' + this.currentMusicIndex + ', åˆ—è¡¨é•¿åº¦: ' + this.musicSources.length);
                return;
            }
            
            debugLog('å¼€å§‹æ’­æ”¾ç¬¬ ' + (this.currentMusicIndex + 1) + ' é¦–éŸ³ä¹: ' + currentSrc);
            
            // é‡ç½®éŸ³é¢‘å…ƒç´ 
            bg.pause();
            bg.currentTime = 0;
            bg.src = currentSrc + '?t=' + Date.now();
            
            // åŠ è½½å¹¶æ’­æ”¾
            bg.load();
            
            const playWhenReady = () => {
                if(!this.isMuted && this.isPlaying) {
                    bg.volume = 0.85;
                    bg.play().catch((error) => {
                        debugLog('éŸ³ä¹æ’­æ”¾å¤±è´¥: ' + error.message + 'ï¼Œéšæœºè·³åˆ°ä¸‹ä¸€é¦–');
                        // æ’­æ”¾å¤±è´¥æ—¶éšæœºè·³åˆ°ä¸‹ä¸€é¦–
                        setTimeout(() => {
                            this.currentMusicIndex = Math.floor(Math.random() * this.musicSources.length);
                            this.playNextMusic();
                        }, 500);
                    });
                }
            };
            
            // ç›‘å¬åŠ è½½å®Œæˆäº‹ä»¶
            bg.addEventListener('canplay', playWhenReady, { once: true });
            
            // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢é•¿æ—¶é—´ç­‰å¾…
            setTimeout(() => {
                if(bg.readyState >= 2) { // HAVE_CURRENT_DATA
                    playWhenReady();
                }
            }, 1000);
        }
        
        // èƒŒæ™¯éŸ³ä¹åŠ è½½æ–¹æ³•ï¼Œå¸¦é”™è¯¯å¤„ç†
        loadBackgroundMusic(bgElement, sourceIndex = 0, fallbackSources = []) {
            // ç§»é™¤è¿™ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨æ›´ç®€å•çš„playNextMusic
            // è¿™ä¸ªæ–¹æ³•å·²è¢«å¼ƒç”¨
            debugLog('loadBackgroundMusicæ–¹æ³•å·²å¼ƒç”¨ï¼Œä½¿ç”¨playNextMusicæ›¿ä»£');
        }

        startMusicPlaylist(){
            if(this.musicStarted || !this.audio || !this.audio.bg || this.isMuted) {
                debugLog('éŸ³ä¹æ’­æ”¾åˆ—è¡¨å¯åŠ¨æ¡ä»¶ä¸æ»¡è¶³: started=' + this.musicStarted + ', audio=' + !!this.audio + ', bg=' + !!(this.audio && this.audio.bg) + ', muted=' + this.isMuted);
                return;
            }
            
            // ç¡®ä¿éŸ³ä¹æºå·²åˆå§‹åŒ–
            if(!this.musicSources || this.musicSources.length === 0) {
                debugLog('åˆå§‹åŒ–éŸ³ä¹æºåˆ—è¡¨');
                const basePath = 'audio/9439/';
                const candidates = ['bg1.mp3', 'bg2.mp3', 'bg3.mp3', 'bg4.mp3', 'bg5.mp3'];
                this.musicSources = candidates.map(n => basePath + n);
            }
            
            debugLog('å¯åŠ¨éŸ³ä¹æ’­æ”¾åˆ—è¡¨ï¼Œå…± ' + this.musicSources.length + ' é¦–éŸ³ä¹');
            // ç¬¬ä¸€é¦–ä¹Ÿéšæœº
            this.currentMusicIndex = Math.floor(Math.random() * this.musicSources.length);
            this.musicStarted = true;
            this.playNextMusic();
        }
        
        attemptPlay() {
            // è¿™ä¸ªæ–¹æ³•å·²è¢«ç®€åŒ–ï¼Œç°åœ¨ç›´æ¥ä½¿ç”¨playNextMusic
            if(!this.musicStarted) {
                this.startMusicPlaylist();
            }
        }
        ensureMusicPlaying(){
            if(!this.audio || !this.audio.bg || this.isMuted) return;
            
            // å¦‚æœéŸ³ä¹æš‚åœäº†ï¼Œé‡æ–°å¯åŠ¨æ’­æ”¾åˆ—è¡¨
            if(this.audio.bg.paused && this.isPlaying) {
                debugLog('æ£€æµ‹åˆ°éŸ³ä¹æš‚åœï¼Œé‡æ–°å¯åŠ¨');
                if(!this.musicStarted) {
                    this.startMusicPlaylist();
                } else {
                    this.playNextMusic();
                }
            }
        }
        play(name,vol=.6){ 
            if(this.isMuted) return; 
            
            if(name==='bg'){ 
                if(!this.musicStarted) {
                    this.startMusicPlaylist(); 
                } else {
                    this.ensureMusicPlaying();
                }
                return; 
            }
            
            const a=this.audio[name];
            if(!a) return;
            try {
                a.currentTime = 0;
                if(name==='win') {
                    a.volume = 0.3;
                } else {
                    a.volume = vol;
                }
                a.play().catch(()=>{});
            } catch(e){}
        }
        toggleMute(){ 
            this.isMuted = !this.isMuted; 
            const btn = document.getElementById('muteBtn'); 
            if(btn) btn.textContent = this.isMuted ? 'ğŸ”‡ è§£é™¤é™éŸ³' : 'ğŸ”Š é™éŸ³'; 
            // åªè°ƒæ•´éŸ³é‡ï¼Œä¸æš‚åœ/é‡æ’­
            if(this.audio && this.audio.bg) {
                this.audio.bg.volume = this.isMuted ? 0 : 0.85;
            }
            // å…¶å®ƒéŸ³æ•ˆä¹Ÿé™éŸ³
            ['pop','combo','win','lose'].forEach(k => {
                if(this.audio && this.audio[k]) {
                    this.audio[k].volume = this.isMuted ? 0 : 1;
                }
            });
            debugLog(this.isMuted ? 'å·²é™éŸ³(ä»…éŸ³é‡)' : 'å–æ¶ˆé™éŸ³(ä»…éŸ³é‡)');
        }
        // ---------- å­˜æ¡£ ----------
        loadUnlocked(){try{const d=localStorage.getItem('match3_unlocked'); if(d) return JSON.parse(d);}catch(e){} return {1:true};}
        saveUnlocked(){try{localStorage.setItem('match3_unlocked',JSON.stringify(this.unlockedLevels));}catch(e){}}
        getCompletedLevels(){try{const d=localStorage.getItem('match3_completed'); if(d) return JSON.parse(d);}catch(e){} return {};}
        saveCompletedLevel(id){try{const c=this.getCompletedLevels(); c[id]=true; localStorage.setItem('match3_completed',JSON.stringify(c));}catch(e){}}
        // ---------- åˆå§‹åŒ–ç”»å¸ƒ ----------
        initCanvas(){ if(this.canvas) return true; this.canvas=document.getElementById('gameCanvas'); if(!this.canvas) return false; this.ctx=this.canvas.getContext('2d'); this.tileSize=this.canvas.width/this.gridCols; const expectedH=this.tileSize*this.gridRows; if(this.canvas.height!==expectedH) this.canvas.height=expectedH; const tip=document.getElementById('tipLayer'); if(tip){tip.style.width=this.canvas.width+'px'; tip.style.height=this.canvas.height+'px';} this.canvas.onclick=e=>this.handleClick(e); requestAnimationFrame(()=>this.render()); return true; }
        setThemeColor(id){
            // ä¿æŒèƒŒæ™¯ä¸ºimage.jpgï¼Œä¸åšä»»ä½•æ›´æ”¹
        }
        levelConfig(id){const target=400+(id-1)*120+Math.floor((id-1)/10)*200; const moves=Math.max(15,this.baseMoves-Math.floor((id-1)/5)); return {target,moves}; }
        startLevel(id){ if(!this.initCanvas()) return; if(id!==0 && !this.unlockedLevels[id]){alert('æœªè§£é”'); return;} this.levelId=id===0?'è‡ªç”±':id; const cfg=id===0?{target:0,moves:9999}:this.levelConfig(id); if(id!==0){ this.gemTypes=Math.min(3+Math.floor((id-1)/8),this.allColors.length); this.gemColors=this.allColors.slice(0,this.gemTypes);} this.targetScore=cfg.target; this.moves=cfg.moves; this.score=0; this.selectedGem=null; this.isPlaying=true; this.currentChain=0; this.effects=[]; this.currentTool=null; this.colorToolAvailable=true; const btn=document.getElementById('toolColorBomb'); if(btn){btn.disabled=false; btn.style.opacity='1'; btn.classList.remove('active');} this.generateInitialGrid(); this.placeObstacles(); this.updateObjectiveUI(); this.updateUI(); this.setThemeColor(id===0?1:id); 
        
        // å¼ºåˆ¶å¯åŠ¨éŸ³ä¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰å¯åŠ¨çš„è¯ï¼‰
        if(!this.musicStarted) {
            debugLog('å…³å¡å¼€å§‹æ—¶å¼ºåˆ¶å¯åŠ¨éŸ³ä¹');
            this.startMusicPlaylist();
        } else {
            this.ensureMusicPlaying();
        }
        
        this.ensureAudioUnlock(); }
        updateObjectiveUI(){const l=document.getElementById('currentLevel'); const o=document.getElementById('objective'); if(l) l.textContent=this.levelId; if(o) o.textContent=this.levelId==='è‡ªç”±'? 'è‡ªç”±æ¨¡å¼ï¼šæ— é™åˆ†æ•°':'ç›®æ ‡åˆ†æ•°: '+this.targetScore;}
        // ---------- æ£‹ç›˜ç”Ÿæˆ ----------
        generateInitialGrid(){this.grid=[]; for(let y=0;y<this.gridRows;y++){this.grid[y]=[]; for(let x=0;x<this.gridCols;x++){let t; do{t=Math.floor(Math.random()*this.gemTypes);}while(this.causesImmediateMatch(x,y,t)); this.grid[y][x]={type:t,x,y,special:null};}}}
        causesImmediateMatch(x,y,t){ if(x>=2 && this.grid[y][x-1] && this.grid[y][x-2] && this.grid[y][x-1].type===t && this.grid[y][x-2].type===t) return true; if(y>=2 && this.grid[y-1] && this.grid[y-2] && this.grid[y-1][x] && this.grid[y-2][x].type===t && this.grid[y-1][x].type===t) return true; return false; }
        placeObstacles(){ if(this.levelId==='è‡ªç”±') return; const iceProb=Math.min(0.03+(this.levelId-1)*0.003,0.25); for(let y=0;y<this.gridRows;y++) for(let x=0;x<this.gridCols;x++){ if(Math.random()<iceProb){ const g=this.grid[y][x]; if(g) g.locked=1; }} }
        // ---------- è¾“å…¥ ----------
        handleClick(e){ if(!this.isPlaying||this.animating) return; const r=this.canvas.getBoundingClientRect(); const x=Math.floor((e.clientX-r.left)/this.tileSize); const y=Math.floor((e.clientY-r.top)/this.tileSize); if(x<0||x>=this.gridCols||y<0||y>=this.gridRows) return; if(this.currentTool){ this.useTool(x,y); return;} const cell=this.grid[y][x]; if(cell&&cell.locked){ this.showTip('ğŸ”’ è¢«å†°å°',(x+0.5)*this.tileSize,(y+0.5)*this.tileSize); return;} if(!this.selectedGem){ this.selectedGem={x,y}; } else { if(this.selectedGem.x===x&&this.selectedGem.y===y) this.selectedGem=null; else if(this.isAdjacent(this.selectedGem,{x,y})){ this.attemptSwap(this.selectedGem,{x,y}); this.selectedGem=null;} else this.selectedGem={x,y}; } }
        // ---------- é“å…· ----------
        activateTool(n){ if(this.animating) return; this.currentTool=this.currentTool===n?null:n; this.highlightTools(); }
        highlightTools(){const map={toolShuffle:'shuffle',toolColorBomb:'color'}; Object.keys(map).forEach(id=>{const el=document.getElementById(id); if(!el) return; if(this.currentTool===map[id]) el.classList.add('active'); else el.classList.remove('active');});}
        useTool(x,y){const t=this.currentTool; const cell=this.grid[y][x]; if(t==='color'){ if(!this.colorToolAvailable){ this.showTip('ğŸš« å·²ä½¿ç”¨',(x+0.5)*this.tileSize,(y+0.5)*this.tileSize); } else if(cell && !cell.obstacle){ cell.special='color'; this.colorToolAvailable=false; const b=document.getElementById('toolColorBomb'); if(b){b.disabled=true; b.style.opacity='.45'; b.classList.remove('active');} this.showTip('ğŸŒˆ',(x+0.5)*this.tileSize,(y+0.5)*this.tileSize);} } else if(t==='shuffle'){ if(this.shuffleBoard()) this.showTip('ğŸ” å·²æ´—ç‰Œ',this.canvas.width/2,this.canvas.height/2);} this.currentTool=null; this.highlightTools(); }
        // ---------- æ ¸å¿ƒé€»è¾‘ ----------
        isAdjacent(a,b){return Math.abs(a.x-b.x)+Math.abs(a.y-b.y)===1;}
        swapRaw(a,b){const g1=this.grid[a.y][a.x]; const g2=this.grid[b.y][b.x]; this.grid[a.y][a.x]=g2; if(g2){g2.x=a.x; g2.y=a.y;} this.grid[b.y][b.x]=g1; if(g1){g1.x=b.x; g1.y=b.y;}}
        attemptSwap(a,b){const g1=this.grid[a.y][a.x]; const g2=this.grid[b.y][b.x]; if((g1&&g1.locked)||(g2&&g2.locked)){ this.showTip('ğŸ”’ æ— æ³•ç§»åŠ¨',(b.x+0.5)*this.tileSize,(b.y+0.5)*this.tileSize); return;} this.swapRaw(a,b); const s1=this.grid[a.y][a.x]; const s2=this.grid[b.y][b.x]; const special=s1.special||s2.special; let groups=this.findMatches(); if(groups.length===0 && special){ this.moves--; this.triggerSpecialSwap(s1,s2); this.updateUI(); return;} if(groups.length===0){ this.swapRaw(a,b); this.play('combo',0.2);} else { this.moves--; this.processMatches(groups,1);} this.updateUI(); }
        findMatches(){const groups=[]; // åŸæœ‰æ°´å¹³ / å‚ç›´
            for(let y=0;y<this.gridRows;y++){ let run=[]; for(let x=0;x<this.gridCols;x++){const c=this.grid[y][x]; if(!c||c.obstacle==='stone'){ if(run.length>=3) groups.push({cells:run.slice(),orientation:'h'}); run=[]; continue;} if(run.length===0||c.type===run[run.length-1].type) run.push(c); else { if(run.length>=3) groups.push({cells:run.slice(),orientation:'h'}); run=[c]; }} if(run.length>=3) groups.push({cells:run.slice(),orientation:'h'});} for(let x=0;x<this.gridCols;x++){ let run=[]; for(let y=0;y<this.gridRows;y++){const c=this.grid[y][x]; if(!c||c.obstacle==='stone'){ if(run.length>=3) groups.push({cells:run.slice(),orientation:'v'}); run=[]; continue;} if(run.length===0||c.type===run[run.length-1].type) run.push(c); else { if(run.length>=3) groups.push({cells:run.slice(),orientation:'v'}); run=[c]; }} if(run.length>=3) groups.push({cells:run.slice(),orientation:'v'});} return groups; }
        detectTShapes(){ const tShapes=[]; for(let y=0;y<this.gridRows;y++){ for(let x=0;x<this.gridCols;x++){ const center=this.grid[y][x]; if(!center) continue; const type=center.type; const inside=(xx,yy)=>yy>=0&&yy<this.gridRows&&xx>=0&&xx<this.gridCols&&this.grid[yy][xx]&&this.grid[yy][xx].type===type; // å››ç§T
                const cond1=inside(x-1,y)&&inside(x+1,y)&&inside(x,y+1)&&inside(x,y+2)&&inside(x,y); // â”¬ (ç«–åœ¨ä¸‹)
                const cond2=inside(x-1,y)&&inside(x+1,y)&&inside(x,y-1)&&inside(x,y-2)&&inside(x,y); // â”´ (ç«–åœ¨ä¸Š)
                const cond3=inside(x,y-1)&&inside(x,y+1)&&inside(x-1,y)&&inside(x-2,y)&&inside(x,y); // â”¤ (æ¨ªåœ¨å·¦)
                const cond4=inside(x,y-1)&&inside(x,y+1)&&inside(x+1,y)&&inside(x+2,y)&&inside(x,y); // â”œ (æ¨ªåœ¨å³)
                if(cond1||cond2||cond3||cond4){
                    // æ”¶é›†æ‰€æœ‰ç»„æˆæ ¼å­ï¼ˆè‡³å°‘5ä¸ªï¼Œå¯èƒ½ 7 ä¸ªï¼Œå¦‚äº¤å‰æ—¶ï¼‰
                    const cells=new Set();
                    cells.add(x+','+y);
                    if(cond1||cond2){ cells.add((x-1)+','+y); cells.add((x+1)+','+y); }
                    if(cond3||cond4){ cells.add(x+','+(y-1)); cells.add(x+','+(y+1)); }
                    if(cond1){ cells.add(x+','+(y+1)); cells.add(x+','+(y+2)); }
                    if(cond2){ cells.add(x+','+(y-1)); cells.add(x+','+(y-2)); }
                    if(cond3){ cells.add((x-1)+','+y); cells.add((x-2)+','+y); }
                    if(cond4){ cells.add((x+1)+','+y); cells.add((x+2)+','+y); }
                    const cellArr=[...cells].map(s=>{const [xx,yy]=s.split(',').map(Number); return {x:xx,y:yy};});
                    // é¿å…é‡å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²æœ‰åŒä¸­å¿ƒ
                    if(!tShapes.find(t=>t.center.x===x&&t.center.y===y)) tShapes.push({center:{x,y},cells:cellArr,type});
                }
            }} return tShapes; }
        processMatches(groups,chain){ if(groups.length===0) return; this.animating=true; const toRemove=new Set(); const specials=[]; const lineActivations=[]; let baseScore=0; // T å½¢æ£€æµ‹
            const tShapes=this.detectTShapes(); const bombCenters=[];
            groups.forEach(g=>{const len=g.cells.length; g.cells.forEach(c=>{toRemove.add(c.y+','+c.x); if(c.special==='lineH'||c.special==='lineV'||c.special==='bomb') lineActivations.push(c);}); if(len===3) baseScore+=60; else if(len===4){ baseScore+=120; const p=g.cells[1]; specials.push({x:p.x,y:p.y,type:p.type,special:g.orientation==='h'?'lineH':'lineV'});} else if(len>=5){ baseScore+=200+(len-5)*40; const p=g.cells[Math.floor(len/2)]; specials.push({x:p.x,y:p.y,type:p.type,special:'color'});} });
            // å¤„ç† T å½¢ï¼šè¦†ç›–ä¸­å¿ƒç‰¹æ®Šï¼Œå¾—åˆ†é¢å¤–å¥–åŠ±
            tShapes.forEach(t=>{ t.cells.forEach(c=>toRemove.add(c.y+','+c.x)); bombCenters.push(t.center); baseScore+=240; });
            // ç§»é™¤ä¸ç‚¸å¼¹ä¸­å¿ƒå†²çªçš„å…¶å®ƒç‰¹æ®Šï¼ˆä¼˜å…ˆç‚¸å¼¹ï¼‰
            for(let i=specials.length-1;i>=0;i--){ if(bombCenters.find(b=>b.x===specials[i].x&&b.y===specials[i].y)) specials.splice(i,1); }
            lineActivations.forEach(c=>{ if(c.special==='lineH'){ for(let x=0;x<this.gridCols;x++) toRemove.add(c.y+','+x); this.addLineEffect('h',c.y,'lineClear'); } else if(c.special==='lineV'){ for(let y=0;y<this.gridRows;y++) toRemove.add(y+','+c.x); this.addLineEffect('v',c.x,'lineClear'); } else if(c.special==='bomb'){ // ç‚¸å¼¹æ‰©æ•£
                    for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){ const nx=c.x+dx, ny=c.y+dy; if(nx>=0&&nx<this.gridCols&&ny>=0&&ny<this.gridRows) toRemove.add(ny+','+nx); } this.addExplosionEffect(c.x,c.y); }
            });
            // å¦‚æœ toRemove ä¸­å«æœ‰ç°æœ‰ç‚¸å¼¹ï¼Œä½¿å…¶çˆ†ç‚¸èŒƒå›´æ‰©å±•
            const extraBombs=[]; toRemove.forEach(k=>{const [y,x]=k.split(',').map(Number); const cell=this.grid[y]&&this.grid[y][x]; if(cell&&cell.special==='bomb'){ extraBombs.push({x,y}); }});
            extraBombs.forEach(b=>{ for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){ const nx=b.x+dx, ny=b.y+dy; if(nx>=0&&nx<this.gridCols&&ny>=0&&ny<this.gridRows) toRemove.add(ny+','+nx); } this.addExplosionEffect(b.x,b.y); });
            const gained=Math.floor((baseScore+toRemove.size*10)*(1+(chain-1)*0.5)); this.score+=gained; this.currentChain=chain; this.play(chain>1?'combo':'pop', chain>1?0.9:0.6); toRemove.forEach(k=>{const [y,x]=k.split(',').map(Number); const cell=this.grid[y][x]; if(cell) this.spawnParticles(x,y,cell); this.grid[y][x]=null;});
            specials.forEach(sp=>{ this.grid[sp.y][sp.x]={type:sp.type,x:sp.x,y:sp.y,special:sp.special};});
            bombCenters.forEach(b=>{ this.grid[b.y][b.x]={type:this.grid[b.y][b.x]?this.grid[b.y][b.x].type:Math.floor(Math.random()*this.gemTypes),x:b.x,y:b.y,special:'bomb'}; });
            this.showTip('+'+gained+(chain>1?' è¿é”x'+(1+(chain-1)*0.5).toFixed(1):''),this.canvas.width/2, this.canvas.height/2 - chain*26); this.updateUI(); this.cascade(chain); }
        triggerSpecialSwap(g1,g2){ const isLine=g=>g&&(g.special==='lineH'||g.special==='lineV');
            if(g1.special==='bomb'||g2.special==='bomb'){ const b=g1.special==='bomb'?g1:g2; this.explodeAt(b.x,b.y); this.cascade(1); return; }
            if(g1.special==='color'&&g2.special==='color'){ const cells=[]; for(let y=0;y<this.gridRows;y++) for(let x=0;x<this.gridCols;x++) cells.push({x,y}); this.clearCells(cells,'åŒå½©è™¹',80); this.showTip('ğŸŒˆğŸŒˆ',this.canvas.width/2,this.canvas.height/2); this.cascade(1); return; }
            if(g1.special==='color'||g2.special==='color'){ const target=g1.special==='color'?g2:g1; const cells=[]; for(let y=0;y<this.gridRows;y++) for(let x=0;x<this.gridCols;x++) if(this.grid[y][x].type===target.type) cells.push({x,y}); this.clearCells(cells,'å½©è™¹æ¸…è‰²',70); this.showTip('ğŸŒˆ',this.canvas.width/2,this.canvas.height/2); this.cascade(1); return; }
            if(isLine(g1)&&isLine(g2)){ const rows=new Set([g1.y,g2.y]); const cols=new Set([g1.x,g2.x]); const cells=[]; rows.forEach(r=>{for(let x=0;x<this.gridCols;x++) cells.push({x,y:r});}); cols.forEach(c=>{for(let y=0;y<this.gridRows;y++) cells.push({x:c,y});}); this.clearCells(cells,'åŒçº¿',65); this.addLineEffect('h',g1.y,'lineClear'); this.addLineEffect('v',g1.x,'lineClear'); this.showTip('âš¡âš¡',this.canvas.width/2,this.canvas.height/2); this.cascade(1); return; }
        }
        explodeAt(x,y){ const cells=[]; for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){ const nx=x+dx, ny=y+dy; if(nx>=0&&nx<this.gridCols&&ny>=0&&ny<this.gridRows) cells.push({x:nx,y:ny}); } this.clearCells(cells,'ç‚¸å¼¹',60); this.addExplosionEffect(x,y); }
        addExplosionEffect(x,y){ this.effects.push({kind:'explosion',x,y,progress:0}); }
        // ---------- è§†è§‰ ----------
        spawnParticles(x,y,gem){ const px=x*this.tileSize+this.tileSize/2; const py=y*this.tileSize+this.tileSize/2; const color=this.gemColors[gem.type%this.gemColors.length]; for(let i=0;i<14;i++){const ang=Math.random()*Math.PI*2; const sp=2+Math.random()*4; this.particles.push({x:px,y:py,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,life:50+Math.random()*20,maxLife:50+Math.random()*20,size:2+Math.random()*3,color,rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-0.5)*0.2,special:gem.special?true:false});} }
        updateParticles(){ this.particles=this.particles.filter(p=>p.life>0); this.particles.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.12; p.vx*=0.985; p.life--; p.rotation+=p.rotationSpeed;}); this.effects=this.effects.filter(e=>e.progress<1); this.effects.forEach(e=>{ e.progress+=0.05;}); }
        drawGem(x,y,type){ const gem=this.grid[y][x]; if(!gem) return; const img=this.images[type%this.images.length]; const cx=x*this.tileSize; const cy=y*this.tileSize; const pad=8; const size=this.tileSize-pad*2; const r=size*0.2; const usable=img && img.complete && !img.failed && img.naturalWidth>0; this.ctx.save(); this.ctx.beginPath(); this.ctx.roundRect(cx+pad,cy+pad,size,size,r); this.ctx.clip(); if(usable){ try{ this.ctx.drawImage(img,cx+pad,cy+pad,size,size);}catch(e){ this.drawFallbackGem(cx,cy,type,gem);} } else { this.drawFallbackGem(cx,cy,type,gem,true);} this.ctx.restore(); this.drawSpecialMarkers(gem,cx,cy); if(gem.locked) this.drawIce(x,y); }
        lightenColor(col,f){const h=col.replace('#',''); const r=parseInt(h.substr(0,2),16),g=parseInt(h.substr(2,2),16),b=parseInt(h.substr(4,2),16); const nr=Math.min(255, r+(255-r)*f), ng=Math.min(255, g+(255-g)*f), nb=Math.min(255, b+(255-b)*f); return 'rgb('+nr+','+ng+','+nb+')'; }
        drawFallbackGem(cx,cy,type,gem,isPlain){const pad=8; const size=this.tileSize-pad*2; const r=size*0.25; const cX=cx+this.tileSize/2, cY=cy+this.tileSize/2; this.ctx.beginPath(); this.ctx.roundRect(cx+pad,cy+pad,size,size,r); const base=this.gemColors[type%this.gemColors.length]; const grad=this.ctx.createRadialGradient(cX,cY,0,cX,cY,size/2); grad.addColorStop(0,this.lightenColor(base,.35)); grad.addColorStop(1,base); this.ctx.fillStyle=grad; this.ctx.fill(); this.ctx.strokeStyle='#fff'; this.ctx.lineWidth=3; this.ctx.stroke(); if(isPlain && !this.imageWarned){ this.imageWarned=true; this.showTip('ä½¿ç”¨é¢œè‰²æ›¿ä»£',this.canvas.width/2,150);} }
        drawSpecialMarkers(gem,cx,cy){ if(!gem.special) return; const centerX=cx+this.tileSize/2, centerY=cy+this.tileSize/2; this.ctx.save(); if(gem.special==='lineH'||gem.special==='lineV'){ this.ctx.strokeStyle='#FFD700'; this.ctx.lineWidth=6; this.ctx.shadowColor='#FFD700'; this.ctx.shadowBlur=10; if(gem.special==='lineH'){ this.ctx.beginPath(); this.ctx.moveTo(cx+this.tileSize*0.15,centerY); this.ctx.lineTo(cx+this.tileSize*0.85,centerY); this.ctx.stroke(); } else { this.ctx.beginPath(); this.ctx.moveTo(centerX,cy+this.tileSize*0.15); this.ctx.lineTo(centerX,cy+this.tileSize*0.85); this.ctx.stroke(); } } else if(gem.special==='color'){ const radius=this.tileSize*0.22; const colors=['#FF0000','#FF7F00','#FFFF00','#00FF00','#0000FF','#4B0082','#9400D3']; for(let i=0;i<7;i++){const a=i*Math.PI*2/7; this.ctx.strokeStyle=colors[i]; this.ctx.lineWidth=4; this.ctx.beginPath(); this.ctx.moveTo(centerX,centerY); this.ctx.lineTo(centerX+Math.cos(a)*radius, centerY+Math.sin(a)*radius); this.ctx.stroke(); } this.ctx.fillStyle='rgba(255,255,255,0.9)'; this.ctx.beginPath(); this.ctx.arc(centerX,centerY,radius*0.5,0,Math.PI*2); this.ctx.fill(); } else if(gem.special==='bomb'){ const r=this.tileSize*0.28; const grad=this.ctx.createRadialGradient(centerX,centerY,0,centerX,centerY,r); grad.addColorStop(0,'#fff8e1'); grad.addColorStop(0.5,'#ffca28'); grad.addColorStop(1,'#ff5722'); this.ctx.fillStyle=grad; this.ctx.beginPath(); this.ctx.arc(centerX,centerY,r,0,Math.PI*2); this.ctx.fill(); this.ctx.lineWidth=3; this.ctx.strokeStyle='#ffd54f'; this.ctx.stroke(); for(let i=0;i<6;i++){ const a=i*Math.PI/3; this.ctx.beginPath(); this.ctx.moveTo(centerX+Math.cos(a)*r*0.3, centerY+Math.sin(a)*r*0.3); this.ctx.lineTo(centerX+Math.cos(a)*r*0.95, centerY+Math.sin(a)*r*0.95); this.ctx.strokeStyle='#ffeb3b'; this.ctx.lineWidth=2; this.ctx.stroke(); } } this.ctx.restore(); }
        render(){ if(!this.ctx) return; // æ¢å¤åŸæœ‰å®Œæ•´ç»˜åˆ¶æµç¨‹ + çˆ†ç‚¸ç‰¹æ•ˆ
            this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
            // ç½‘æ ¼
            this.ctx.strokeStyle='#2224'; this.ctx.lineWidth=1;
            for(let x=0;x<=this.gridCols;x++){ this.ctx.beginPath(); this.ctx.moveTo(x*this.tileSize,0); this.ctx.lineTo(x*this.tileSize,this.gridRows*this.tileSize); this.ctx.stroke(); }
            for(let y=0;y<=this.gridRows;y++){ this.ctx.beginPath(); this.ctx.moveTo(0,y*this.tileSize); this.ctx.lineTo(this.gridCols*this.tileSize,y*this.tileSize); this.ctx.stroke(); }
            // å®çŸ³
            for(let y=0;y<this.gridRows;y++) for(let x=0;x<this.gridCols;x++){ const cell=this.grid[y][x]; if(!cell) continue; this.drawGem(x,y,cell.type); }
            // é€‰ä¸­æ¡†
            if(this.selectedGem){ this.ctx.strokeStyle='#ff0000'; this.ctx.lineWidth=3; this.ctx.strokeRect(this.selectedGem.x*this.tileSize+2,this.selectedGem.y*this.tileSize+2,this.tileSize-4,this.tileSize-4); }
            // ç²’å­ & æ•ˆæœè¿›åº¦
            this.updateParticles();
            // ç²’å­æ¸²æŸ“
            this.particles.forEach(p=>{ const a=p.life/p.maxLife; this.ctx.save(); this.ctx.globalAlpha=a; this.ctx.translate(p.x,p.y); this.ctx.rotate(p.rotation); this.ctx.fillStyle=p.color; this.ctx.shadowColor=p.color; this.ctx.shadowBlur=p.special?10:6; this.ctx.beginPath(); if(p.special){ for(let i=0;i<5;i++){ const ang=i*Math.PI*2/5; const xx=Math.cos(ang)*p.size; const yy=Math.sin(ang)*p.size; if(i===0) this.ctx.moveTo(xx,yy); else this.ctx.lineTo(xx,yy);} } else { this.ctx.arc(0,0,p.size,0,Math.PI*2);} this.ctx.closePath(); this.ctx.fill(); this.ctx.restore(); });
            // ç‰¹æ•ˆæ¸²æŸ“ï¼ˆå«çˆ†ç‚¸ï¼‰
            this.effects.forEach(e=>{ const t=e.progress; this.ctx.save(); if(e.kind==='lineClear'){ const alpha=1-t; this.ctx.globalCompositeOperation='lighter'; if(e.orientation==='h'){ const y=e.index*this.tileSize; this.ctx.fillStyle='rgba(255,215,0,'+(0.4+0.3*Math.sin(t*8))+')'; this.ctx.fillRect(0,y,this.canvas.width,this.tileSize); this.ctx.fillStyle='rgba(255,255,255,'+alpha+')'; this.ctx.fillRect(0,y+this.tileSize*0.4,this.canvas.width,this.tileSize*0.2);} else { const x=e.index*this.tileSize; this.ctx.fillStyle='rgba(255,215,0,'+(0.4+0.3*Math.sin(t*8))+')'; this.ctx.fillRect(x,0,this.tileSize,this.canvas.height); this.ctx.fillStyle='rgba(255,255,255,'+alpha+')'; this.ctx.fillRect(x+this.tileSize*0.4,0,this.tileSize*0.2,this.canvas.height);} } else if(e.kind==='explosion'){ const p=t; const maxR=this.tileSize*2.2; const r=maxR*p; this.ctx.globalCompositeOperation='lighter'; const cx=e.x*this.tileSize+this.tileSize/2; const cy=e.y*this.tileSize+this.tileSize/2; const g=this.ctx.createRadialGradient(cx,cy,0,cx,cy,r); g.addColorStop(0,'rgba(255,255,255,'+(1-p)+')'); g.addColorStop(.3,'rgba(255,200,0,'+(0.8*(1-p))+')'); g.addColorStop(1,'rgba(255,80,0,0)'); this.ctx.fillStyle=g; this.ctx.beginPath(); this.ctx.arc(cx,cy,r,0,Math.PI*2); this.ctx.fill(); } else { const pulse=(Math.sin(t*10)+1)/2; this.ctx.globalAlpha=1-t; if(e.orientation==='h'){ const y=e.index*this.tileSize; this.ctx.fillStyle='rgba(255,255,0,'+(0.25+0.25*pulse)+')'; this.ctx.fillRect(0,y,this.canvas.width,this.tileSize);} else { const x=e.index*this.tileSize; this.ctx.fillStyle='rgba(255,255,0,'+(0.25+0.25*pulse)+')'; this.ctx.fillRect(x,0,this.tileSize,this.canvas.height);} } this.ctx.restore(); });
            requestAnimationFrame(()=>this.render()); }

        // ====== ä»¥ä¸‹ä¸ºä¹‹å‰ç‰ˆæœ¬ä¸­é—æ¼çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè¡¥å› ======
        ensureAudioUnlock(){ 
            if(this.audioUnlocked) return;
            
            // ç«‹å³å°è¯•è§£é”éŸ³é¢‘ï¼Œä¸ç­‰å¾…ç”¨æˆ·äº¤äº’
            const tryUnlock = () => {
                let unlockPromises = [];
                ['bg','pop','combo','win','lose'].forEach(k => {
                    const el = this.audio[k];
                    if(!el) return;
                    try {
                        const originalVolume = el.volume;
                        const originalMuted = el.muted;
                        
                        // å°è¯•é™éŸ³æ’­æ”¾æ¥è§£é”éŸ³é¢‘ä¸Šä¸‹æ–‡
                        el.volume = 0.001;
                        el.muted = true;
                        
                        const playPromise = el.play();
                        if(playPromise && playPromise.then) {
                            unlockPromises.push(
                                playPromise.then(() => {
                                    el.pause();
                                    el.currentTime = 0;
                                    el.volume = originalVolume;
                                    el.muted = originalMuted;
                                }).catch(() => {
                                    el.volume = originalVolume;
                                    el.muted = originalMuted;
                                })
                            );
                        } else {
                            el.pause();
                            el.currentTime = 0;
                            el.volume = originalVolume;
                            el.muted = originalMuted;
                        }
                    } catch(e) {
                        // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­å°è¯•å…¶ä»–éŸ³é¢‘å…ƒç´ 
                    }
                });
                
                // å½“æ‰€æœ‰éŸ³é¢‘å…ƒç´ å°è¯•å®Œæˆåæ ‡è®°ä¸ºå·²è§£é”
                Promise.allSettled(unlockPromises).then(() => {
                    this.audioUnlocked = true;
                    if(this.canvas) {
                        this.showTip('ğŸµ éŸ³é¢‘å·²å°±ç»ª', this.canvas.width/2, 120);
                    }
                });
            };
            
            // ç«‹å³å°è¯•è§£é”
            tryUnlock();
            
            // å¦‚æœç«‹å³è§£é”å¤±è´¥ï¼Œæ³¨å†Œç”¨æˆ·äº¤äº’äº‹ä»¶ä½œä¸ºåå¤‡æ–¹æ¡ˆ
            const unlockOnInteraction = () => {
                ['click','touchstart','keydown'].forEach(ev => 
                    document.removeEventListener(ev, unlockOnInteraction)
                );
                if(!this.audioUnlocked) {
                    tryUnlock();
                }
            };
            ['click','touchstart','keydown'].forEach(ev => 
                document.addEventListener(ev, unlockOnInteraction, {once:true})
            );
        }
        addLineEffect(orientation,index,kind='lineClear'){ this.effects.push({orientation,index,progress:0,kind}); }
        drawIce(x,y){ const cx=x*this.tileSize, cy=y*this.tileSize, pad=6, size=this.tileSize-pad*2, r=size*0.18; this.ctx.save(); this.ctx.beginPath(); this.ctx.roundRect(cx+pad,cy+pad,size,size,r); const g=this.ctx.createLinearGradient(cx,cy,cx+this.tileSize,cy+this.tileSize); g.addColorStop(0,'rgba(173,216,230,0.85)'); g.addColorStop(.5,'rgba(135,206,250,0.95)'); g.addColorStop(1,'rgba(173,216,230,0.85)'); this.ctx.fillStyle=g; this.ctx.fill(); this.ctx.strokeStyle='rgba(70,130,180,0.95)'; this.ctx.lineWidth=3; this.ctx.stroke(); this.ctx.strokeStyle='rgba(255,255,255,0.75)'; this.ctx.lineWidth=2; const cX=cx+this.tileSize/2, cY=cy+this.tileSize/2, s=this.tileSize*0.28; this.ctx.beginPath(); this.ctx.moveTo(cX-s/2,cY); this.ctx.lineTo(cX+s/2,cY); this.ctx.moveTo(cX,cY-s/2); this.ctx.lineTo(cX,cY+s/2); this.ctx.moveTo(cX-s/3,cY-s/3); this.ctx.lineTo(cX+s/3,cY+s/3); this.ctx.moveTo(cX+s/3,cY-s/3); this.ctx.lineTo(cX-s/3,cY+s/3); this.ctx.stroke(); this.ctx.restore(); }
        updateUI(){const s=document.getElementById('score'), m=document.getElementById('moves'), c=document.getElementById('chainInfo'); if(s) s.textContent=this.score; if(m) m.textContent=this.levelId==='è‡ªç”±'?'âˆ':this.moves; if(c) c.textContent=this.currentChain>1? this.currentChain+'è¿ (x'+(1+(this.currentChain-1)*0.5).toFixed(1)+')':'-'; }
        showTip(text,x,y){ const layer=document.getElementById('tipLayer'); if(!layer) return; const d=document.createElement('div'); d.className='floating-tip'; d.textContent=text; d.style.left=x+'px'; d.style.top=y+'px'; layer.appendChild(d); setTimeout(()=>{ if(d.parentNode) d.parentNode.removeChild(d); },1400); }
        clearCells(cells,reason,base=50){ const uniq=new Set(); cells.forEach(c=>uniq.add(c.x+','+c.y)); let count=0; uniq.forEach(k=>{const [x,y]=k.split(',').map(Number); const cell=this.grid[y]&&this.grid[y][x]; if(!cell) return; if(cell.locked){ cell.locked=0; this.spawnParticles(x,y,cell); count++; return;} this.spawnParticles(x,y,cell); this.grid[y][x]=null; count++;}); this.score+=count*base; this.updateUI(); }
        cascade(chain){ // ä¸‹è½å¹¶å¡«å……
            for(let x=0;x<this.gridCols;x++){
                for(let y=this.gridRows-1;y>=0;y--){
                    if(this.grid[y][x]==null){
                        for(let k=y-1;k>=0;k--){
                            if(this.grid[k][x]!=null){
                                this.grid[y][x]=this.grid[k][x];
                                this.grid[y][x].y=y;
                                this.grid[k][x]=null;
                                break;
                            }
                        }
                    }
                }
            }
            for(let y=0;y<this.gridRows;y++) for(let x=0;x<this.gridCols;x++) if(this.grid[y][x]==null) this.grid[y][x]={type:Math.floor(Math.random()*this.gemTypes),x,y,special:null};
            const newGroups=this.findMatches();
            if(newGroups.length>0){ setTimeout(()=>this.processMatches(newGroups,chain+1),220);} else { this.animating=false; setTimeout(()=>{this.currentChain=0; this.updateUI();},500); this.ensureMoves(); this.postMoveCheck(); }
        }
        hasPossibleMoves(){ const trySwap=(ax,ay,bx,by)=>{const A=this.grid[ay][ax]; const B=this.grid[by][bx]; if(!A||!B) return false; this.grid[ay][ax]=B; this.grid[by][bx]=A; const ok=this.findMatches().length>0; this.grid[ay][ax]=A; this.grid[by][bx]=B; return ok;}; for(let y=0;y<this.gridRows;y++) for(let x=0;x<this.gridCols;x++){ if(x+1<this.gridCols && trySwap(x,y,x+1,y)) return true; if(y+1<this.gridRows && trySwap(x,y,x,y+1)) return true;} return false; }
        shuffleBoard(){ const flat=[]; for(let y=0;y<this.gridRows;y++) for(let x=0;x<this.gridCols;x++) if(this.grid[y][x]) flat.push(this.grid[y][x]); let attempts=0; while(attempts<80){ for(let i=flat.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [flat[i],flat[j]]=[flat[j],flat[i]];} let idx=0; for(let y=0;y<this.gridRows;y++) for(let x=0;x<this.gridCols;x++){const g=flat[idx++]; g.x=x; g.y=y; this.grid[y][x]=g;} if(this.findMatches().length===0 && this.hasPossibleMoves()) return true; attempts++; } return false; }
        ensureMoves(){ if(!this.hasPossibleMoves()){ if(this.shuffleBoard()) this.showTip('ğŸ” è‡ªåŠ¨æ´—ç‰Œ',this.canvas.width/2,this.canvas.height/2); else this.showTip('âš ï¸ æ´—ç‰Œå¤±è´¥',this.canvas.width/2,this.canvas.height/2);} }
        postMoveCheck(){ if(this.levelId!=='è‡ªç”±' && this.score>=this.targetScore){ this.levelWin(); } else if(this.moves<=0 && this.levelId!=='è‡ªç”±'){ this.levelFail(); } }
        levelWin(){ this.play('win',0.9); this.saveCompletedLevel(this.levelId); alert('å…³å¡ '+this.levelId+' å®Œæˆ! åˆ†æ•°:'+this.score); if(!this.unlockedLevels[this.levelId+1]){ this.unlockedLevels[this.levelId+1]=true; this.saveUnlocked(); } this.isPlaying=false; SimpleUI.showScreen('levelSelect'); }
        levelFail(){ this.play('lose',0.9); alert('å…³å¡å¤±è´¥! åˆ†æ•°:'+this.score); this.isPlaying=false; SimpleUI.showScreen('levelSelect'); }
        // ====== è¡¥å›æ–¹æ³•ç»“æŸ ======
    }

    // ================== åˆå§‹åŒ– ==================
    function initGame(){ 
        try{ 
            GameEngine=new SimpleGameEngine(); 
            const q=id=>document.getElementById(id); 
            
            q('startGameBtn').onclick=()=>{
                SimpleUI.startLevel(1);
            }; 
            q('levelSelectBtn').onclick=()=>SimpleUI.showScreen('levelSelect'); 
            q('freePlayBtn').onclick=()=>{
                SimpleUI.startLevel(0);
            }; 
            q('backToMenuBtn').onclick=()=>SimpleUI.showScreen('mainMenu'); 
            q('restartBtn').onclick=()=>GameEngine.startLevel(GameEngine.levelId==='è‡ªç”±'?0:GameEngine.levelId); 
            q('backToLevelSelectBtn').onclick=()=>SimpleUI.showScreen('levelSelect'); 
            q('muteBtn').onclick=()=>GameEngine.toggleMute(); 
            q('toolShuffle').onclick=()=>{
                if(GameEngine && GameEngine.isPlaying) {
                    if(GameEngine.shuffleBoard()) {
                        GameEngine.showTip('ğŸ” å·²æ´—ç‰Œ', GameEngine.canvas.width/2, GameEngine.canvas.height/2);
                        GameEngine.render();
                    }
                }
            }; 
            q('toolColorBomb').onclick=()=>GameEngine.activateTool('color'); 
            let addMovesUsed = false;
            q('addMovesBtn').onclick=()=>{
                if(GameEngine && GameEngine.isPlaying && !addMovesUsed) {
                    const add = Math.floor(Math.random()*3)+3; // 3~5
                    GameEngine.moves += add;
                    GameEngine.updateUI();
                    GameEngine.showTip('æ­¥æ•°+'+add, 120, 120);
                    addMovesUsed = true;
                    q('addMovesBtn').disabled = true;
                    q('addMovesBtn').style.opacity = '0.5';
                }
            };
            // æ¯æ¬¡å¼€å§‹æ–°å…³å¡æ—¶é‡ç½®åŠ æ­¥æ•°æŒ‰é’®
            const origStartLevel = GameEngine.startLevel.bind(GameEngine);
            GameEngine.startLevel = function(id) {
                addMovesUsed = false;
                const btn = document.getElementById('addMovesBtn');
                if(btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
                origStartLevel(id);
            };
            // é¡µé¢åŠ è½½å®Œæˆåç«‹å³å°è¯•å¯åŠ¨éŸ³é¢‘å’ŒéŸ³ä¹
            debugLog('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ - éŸ³æ•ˆå·²è‡ªåŠ¨åŠ è½½');
            setTimeout(()=>{
                const d=q('debugInfo'); 
                if(d) d.style.display='none';
            },1200);
        } catch(e) {
            console.error(e); 
            showError('åˆå§‹åŒ–å¤±è´¥:'+e.message);
        } 
    
    }
    window.addEventListener('error',e=>debugLog('è„šæœ¬é”™è¯¯: '+e.message)); window.addEventListener('unhandledrejection',e=>debugLog('Promiseé”™è¯¯: '+e.reason));

    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',initGame); else initGame();
    </script>
</body>
</html>
